name: snowflake-devops-demo

on:
  push:
    branches:
      - main
    paths:
      - 'migrations/**'

  workflow_dispatch:

jobs:
  deploy-snowflake-changes-job:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Setup Python
      - name: Setup Python 3.8
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      # 3️⃣ Install schemachange
      - name: Install schemachange
        run: |
          python --version
          pip install --upgrade pip
          pip install schemachange

      # 4️⃣ Debug – Verify GitHub secrets are loaded
      - name: Debug Snowflake connection variables
        env:
          SF_ACCOUNT: ${{ secrets.SF_ACCOUNT }}
          SF_USERNAME: ${{ secrets.SF_USERNAME }}
          SF_ROLE: ${{ secrets.SF_ROLE }}
          SF_WAREHOUSE: ${{ secrets.SF_WAREHOUSE }}
          SF_DATABASE: ${{ secrets.SF_DATABASE }}
          SF_SCHEMA: ${{ secrets.SF_SCHEMA }}
        run: |
          echo "SF_ACCOUNT: $SF_ACCOUNT"
          echo "SF_USERNAME: $SF_USERNAME"
          echo "SF_ROLE: $SF_ROLE"
          echo "SF_WAREHOUSE: $SF_WAREHOUSE"
          echo "SF_DATABASE: $SF_DATABASE"
          echo "SF_SCHEMA: $SF_SCHEMA"

      # 5️⃣ Create connections.toml dynamically from secrets
      - name: Create schemachange connections.toml
        env:
          SF_ACCOUNT: ${{ secrets.SF_ACCOUNT }}
          SF_USERNAME: ${{ secrets.SF_USERNAME }}
          SF_PASSWORD: ${{ secrets.SF_PASSWORD }}
          SF_ROLE: ${{ secrets.SF_ROLE }}
          SF_WAREHOUSE: ${{ secrets.SF_WAREHOUSE }}
          SF_DATABASE: ${{ secrets.SF_DATABASE }}
          SF_SCHEMA: ${{ secrets.SF_SCHEMA }}
        run: |
          echo "Creating connections.toml file..."
          cat <<EOF > connections.toml
[connections.default]
account = "${SF_ACCOUNT}"
user = "${SF_USERNAME}"
password = "${SF_PASSWORD}"
role = "${SF_ROLE}"
warehouse = "${SF_WAREHOUSE}"
database = "${SF_DATABASE}"
schema = "${SF_SCHEMA}"
EOF

          echo "Generated connections.toml (password masked):"
          cat connections.toml | sed 's/password = .*/password = "***"/'

      # 6️⃣ Run schemachange migration
      - name: Run schemachange deployment
        run: |
          echo "Running schemachange..."
          schemachange -f migrations -c connections.toml --create-change-history-table
